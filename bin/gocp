#!/bin/bash
#
# gcp: easy copy file from other machine
#
# usage:
#        eg: gcp bb2020:/home/work/abc.jpg ./
#

FULLNAME=`readlink -f $0`
source "$(dirname ${FULLNAME})/func.inc.sh"

usage() { cat <<EOF
Usage: $PROGRAM src dst

Example:    
    $PROGRAM foo:dir/bar dst
    $PROGRAM dir/foo     bar

Bug Report:
    sunshengxiang01@baidu.com
EOF
}

SSHPASS="$CWD/sshpass"
RSYNC="$CWD/rsync"
VERSION='3.14'


addr2ssh()
{
    # change g addr to ssh addr, return by ADDR
    if test $# -ne 1;then
        exit 1
    fi

    if echo $1 | grep ':' > /dev/null
    then
        local HOST RMTPATH

        GGREPFLAGS=

        HOST=$(echo "$1" | awk -F: '{print $1}')
        RMTPATH=$(echo "$1" | awk -F: '{print $2}' | sed 's;/$;;')

        if echo "$HOST" | grep -q '@'
        then
            USER=`echo $HOST | cut -d'@' -f1`
            HOST=`echo $HOST | cut -d'@' -f2`
            GGREPFLAGS="$GGREPFLAGS -u $USER"
        fi

        read HOST PASSWORD < <($GOGREP $GGREPFLAGS $HOST)
        test $? -ne 0 && error "hostname not matched"
        ADDR="$HOST:$RMTPATH"
    else
        ADDR="$1"
    fi
}

quite= recurise= password=

while test $# -ne 0
do
    case $1 in
    -q)     quite=true
            ;;
    -r)     recurise=true
            ;;
    -v| --version)
            version; exit
            ;;
    *)
            break
            ;;
    esac
    shift
done

test $# -ne 2 && usage_and_exit 1

RSYNCFLAGS="-avz" 
test "$quite" == "true" && RSYNCFLAGS="$RSYNCFLAGS -q"

addr2ssh $1;    SOURCE=$ADDR
addr2ssh $2;    TARGET=$ADDR

$SSHPASS -p "$PASSWORD" $RSYNC $RSYNCFLAGS -e "ssh -o StrictHostKeyChecking=no" $SOURCE $TARGET 1>&2

